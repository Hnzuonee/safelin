<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Safe Link</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; }
    .wrap { max-width: 520px; margin: 0 auto; }
    button { padding: 14px 18px; border-radius: 12px; border: 0; font-size: 16px; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    .status { margin-top: 14px; font-size: 14px; }
    .hidden { display: none; }
    .card { padding: 18px; border-radius: 16px; box-shadow: 0 2px 14px rgba(0,0,0,.08); margin-top: 16px; }
  </style>
  <script defer src="https://challenges.cloudflare.com/turnstile/v0/api.js"></script>
</head>
<body>
  <div class="wrap">
    <h1>Pokračovat</h1>
    <p>Pro bezpečné pokračování ověř prosím, že nejsi robot.</p>

    <!-- Turnstile widget: nepoužívej "invisible". -->
    <div id="ts-widget"
         class="cf-turnstile"
         data-sitekey="PASTE_YOUR_SITE_KEY_HERE"
         data-size="flexible"
         data-callback="onTsSuccess"
         data-error-callback="onTsError"
         data-timeout-callback="onTsTimeout">
    </div>

    <div class="card">
      <button id="goBtn">Vstoupit</button>
      <div id="msg" class="status"></div>
    </div>
  </div>

  <script>
    let isExecuting = false;
    let lastToken = "";

    const $btn = document.getElementById('goBtn');
    const $msg = document.getElementById('msg');

    function setMsg(text) { $msg.textContent = text; }
    function setBusy(busy) { $btn.disabled = busy; isExecuting = busy; }

    // Turnstile callbacks
    window.onTsSuccess = function(token) {
      lastToken = token || "";
      setMsg("Ověřeno, pokračuji…");
      doRedirect(lastToken);
    };

    window.onTsError = function() {
      setBusy(false);
      setMsg("Chyba ověření. Zkus to prosím znovu.");
    };

    window.onTsTimeout = function() {
      setBusy(false);
      setMsg("Čas ověření vypršel. Zkus to znovu.");
    };

    async function doRedirect(token) {
      try {
        if (!token) {
          setBusy(false);
          setMsg("Token chybí. Zkus tlačítko znovu.");
          return;
        }

        // GET varianta (držím se tvého dřívějšího kódu)
        const res = await fetch(`/redirect?token=${encodeURIComponent(token)}`, {
          method: 'GET',
          redirect: 'manual' // čekáme 303 ze serveru
        });

        // Pokud nám server rovnou vrátí 303/Location, prohlížeč ji sám nenasleduje při redirect: 'manual'.
        // Vezmeme Location a přesměrujeme.
        if (res.status === 303 || res.status === 302 || res.status === 301) {
          const loc = res.headers.get('Location');
          if (loc) {
            window.location.href = loc;
            return;
          }
        }

        // V opačném případě čekáme JSON s chybou / infem
        let data = null;
        try { data = await res.json(); } catch {}

        if (res.ok && data && data.redirect) {
          window.location.href = data.redirect;
          return;
        }

        setBusy(false);
        setMsg(data && data.error ? `Server chyba: ${data.error}` : `Server chyba (${res.status}).`);
        // nový pokus vyžaduje nový token
        if (window.turnstile) turnstile.reset('#ts-widget');
        lastToken = "";
      } catch (e) {
        setBusy(false);
        setMsg("Síťová chyba. Zkus to znovu.");
        if (window.turnstile) turnstile.reset('#ts-widget');
        lastToken = "";
      }
    }

    $btn.addEventListener('click', async () => {
      if (isExecuting) return;
      setBusy(true);
      setMsg("Ověřuji…");

      // Pokud už máme token (už proběhlo ověření), rovnou pokračuj.
      if (lastToken) {
        doRedirect(lastToken);
        return;
      }

      // Spusť ověření Turnstile – u viditelného widgetu stačí reset/čekat na callback.
      try {
        if (window.turnstile) {
          // Když widget visí v "executing" stavu, resetni
          turnstile.reset('#ts-widget');
        }
        // U "flexible/normal/compact" se challenge zobrazí a po úspěchu zavolá onTsSuccess()
      } catch (e) {
        setBusy(false);
        setMsg("Chyba při spuštění ověření.");
      }
    });
  </script>
</body>
</html>
